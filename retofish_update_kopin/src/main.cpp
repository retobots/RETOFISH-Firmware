#include <Arduino.h>
#include <Wire.h>   // cần thêm cái này để quét I2C
#include <RTClib.h>

// HAL layer
#include "hal/Battery.h"
#include "hal/RTC.h"
#include "hal/StatusLed.h"
#include "hal/Button.h"
#include "hal/TftDisplay.h"
#include "hal/BlynkComm.h"
#include "hal/StepperMotor.h"

// Service layer
#include "services/FeedingService.h"
#include "services/ScheduleManager.h"
#include "services/StatusReporter.h"

static bool screenOn = false;
static unsigned long screenOnTime = 0;

static bool feeding = false;
static unsigned long feedingStartTime = 0;

static bool warnSpam = false;
static unsigned long warnStartTime = 0;

static unsigned long lastManualFeedTime = 0;


void setup() {
  Serial.begin(9600);
  delay(500);
  

  // --- Hardware initialization ---
  Battery::getInstance().setup();
  RTC::getInstance().setup();

  StatusLed::getInstance().setup(12, 13, 15);
  // Button::getInstance().setup(19,17,16);
  Button::getInstance().setup(19,34,35);
  
  // TftDisplay::getInstance().setup(5, 2, 4);
  TftDisplay::getInstance().setup(5, 2, 4, 14); 
    screenOn = true;
    screenOnTime = millis();

  StepperMotor::getInstance().setup();
  BlynkComm::getInstance().setup();

  // --- Service layer initialization ---
  FeedingService::getInstance().setup();
  ScheduleManager::getInstance().setup();
  StatusReporter::getInstance().setup();

  lastManualFeedTime = millis() - 30000;
 
}


void loop() {

    FeedingService::getInstance().loop();
    delay(20);

}
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































